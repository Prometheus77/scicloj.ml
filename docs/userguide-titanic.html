<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.0/sandstone/bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/solarized-light.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/24.0.0/styles/ag-grid.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/24.0.0/styles/ag-theme-balham.min.css" rel="stylesheet" type="text/css">
        <link href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" rel="stylesheet" type="text/css">

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
        <!-- The loading of KaTeX is deferred to speed up page rendering -->
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
    </head>
    <body>
        <p id="loading">Loading ...</p>
        <div id="app"></div>
    </body>
    <script src="https://cdn.statically.io/gh/scicloj/gorilla-notes@master/dist/0.5.10/main.js"></script>
    <script>
     shadow.loader.load("main");
     gorilla_notes.main.main_BANG_(false, "{:options {:reverse-notes? false, :header? false, :notes-in-cards? false, :initially-collapse? false, :auto-scroll? false, :port 1903, :custom-header [:div {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} \"(notespace)\" [:p \"Sat Mar 27 22:01:40 CET 2021\"] nil [:hr]], :custom-footer [:div [:hr] [:hr]]}, :ids [\"295\" \"296\" \"297\" \"298\" \"299\" \"300\" \"301\" \"302\" \"182\" \"303\" \"304\" \"305\" \"186\" \"187\" \"306\" \"307\" \"308\" \"309\" \"310\" \"311\" \"312\" \"260\" \"196\" \"261\" \"198\" \"199\" \"313\" \"314\" \"315\" \"316\" \"317\" \"204\" \"318\" \"267\" \"319\" \"320\" \"321\" \"322\" \"323\" \"273\" \"274\" \"233\" \"275\" \"276\" \"324\" \"278\" \"325\" \"280\" \"326\" \"282\" \"327\" \"284\" \"328\" \"329\" \"330\" \"331\" \"332\" \"333\"], :id->content {\"273\" [:div [:p] nil nil [:p/markdown \"This defines a pipeline with options. The options gets passed to the model function,\\nso become hyper-parameters of the model.\\n\\nThe `use-age?` options is used to make a conditional pipeline. As the use-age? variable becomes part of the grid to search in,\\nwe tune it as well.\\nThis is an example how pipeline-options can be grid searched in the same way then hyper-parameters of the model.\\n\\n\"]], \"275\" [:div [:p] [:div [:p/code {:code \"(def search-grid\\n  (->>\\n   (ml/sobol-gridsearch {:trees (ml/linear 100 500 10)\\n                           :split-rule (ml/categorical [:gini :entropy])\\n                           :max-depth (ml/linear 1 50 10 )\\n                           :node-size (ml/linear 1 10 10)\\n                           :sample-rate (ml/linear 0.1 1 10)\\n                           :use-age? (ml/categorical [true false])})\\n   (take 10))\\n  )\", :bg-class \"bg-light\"}]] nil nil], \"303\" [:div [:p] [:div [:p/code {:code \"(def ds-split (first (ds/split->seq data :holdout {:ratio [0.8 0.2]\\n                                                               :split-names [:train-val :test]}\\n                                                      )))\", :bg-class \"bg-light\"}]] nil nil], \"321\" [:div [:p] [:div [:p/code {:code \"(def trueth\\n  (->\\n   (pipeline-fn {:metamorph/data (:test ds-split) :metamorph/mode :fit })\\n   :metamorph/data\\n   tech.v3.dataset.modelling/labels))\", :bg-class \"bg-light\"}]] nil nil], \"305\" [:div [:p] [:div [:p/code {:code \"(def train-val-splits\\n    (ds/split->seq\\n     (:train-val ds-split)\\n     :kfold\\n     {:k 10}))\", :bg-class \"bg-light\"}]] nil nil], \"300\" [:div [:p] [:div [:p/code {:code \"(def data (ds/dataset \\\"data/titanic/train.csv\\\" {:key-fn csk/->kebab-case-keyword}))\", :bg-class \"bg-light\"}]] nil nil], \"315\" [:div [:p] [:div [:p/code {:code \"(-> models first :metric )\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"0.8333333333333333\\n\"}]], \"304\" [:div [:p] nil nil [:p/markdown \"Create a sequence of train/test  (k-fold with k=10) splits used to evaluate the pipeline.\"]], \"295\" [:div [:p] [:div [:p/code {:code \"(comment\\n  (note/init-with-browser)\\n  (notespace.api/update-config\\n   #(assoc % :source-base-path \\\"userguide\\\"))\\n  (note/eval-this-notespace)\\n  (note/reread-this-notespace)\\n  (note/render-static-html \\\"docs/userguide-titanic.html\\\")\\n\\n  (note/init)\\n  )\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"nil\\n\"}]], \"196\" [:div [:p] nil nil [:p/markdown \"Return a single model only (as a list of 1) , namely the best over all\\n pipeline functions\\nand all cross validations is the default behavoiur, but can be changed\\nwith the `tune options`.\"]], \"282\" [:div [:p] nil nil [:p/markdown \"As we did 10 pipelines and 10 fold cross validation, we have 100 models ttrained in total \"]], \"302\" [:div [:p] [:div [:p/code {:code \"(ds/column-names data)\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"(:passenger-id\\n :survived\\n :pclass\\n :name\\n :sex\\n :age\\n :sib-sp\\n :parch\\n :ticket\\n :fare\\n :cabin\\n :embarked)\\n\"}]], \"116\" [:div [:p] nil nil [:p/markdown \"using options: \"]], \"274\" [:div [:p] [:div [:p/code {:code \"(defn make-pipeline-fn [options]\\n\\n  (ml/pipeline\\n   (if (:use-age? options)\\n     (mm/select-columns [:survived :pclass :name :sex :age])\\n     (mm/select-columns [:survived :pclass :name :sex])\\n     )\\n   (ml/lift name->title)\\n   (mm/categorical->number [:survived :pclass :sex :title])\\n   (mm/set-inference-target :survived)\\n   {:metamorph/id :model}\\n   (mm/model\\n    (merge options\\n           {:model-type :smile.classification/random-forest}))))\", :bg-class \"bg-light\"}]] nil nil], \"299\" [:div [:p] nil nil [:p/markdown \"### Read data\"]], \"329\" [:div [:p] nil nil [:p/markdown \"which is: \"]], \"328\" [:div [:p] [:div [:p/code {:code \"(def best-model (first models))\", :bg-class \"bg-light\"}]] nil nil], \"332\" [:div [:p] nil nil [:p/markdown \"using options: \"]], \"318\" [:div [:p] nil nil [:p/markdown \"We do this by running the pipeline again, this time with new data and merging\\n:mode transform\"]], \"296\" [:div [:p] [:div [:p/code {:code \"(require '[scicloj.ml.dataset :as ds]\\n         '[scicloj.ml.core :as ml]\\n         '[scicloj.ml.metamorph :as mm]\\n         '[camel-snake-kebab.core :as csk]\\n         '[scicloj.metamorph.ml.loss :as loss]\\n         '[clojure.string :as str])\", :bg-class \"bg-light\"}]] nil nil], \"326\" [:div [:p] [:div [:p/code {:code \"(def models\\n  (->> evaluations\\n       flatten\\n       (map\\n        #(assoc\\n          (select-keys % [:metric :fit-ctx])\\n          :model (ml/thaw-model (get-in % [:fit-ctx :model]))\\n          :data (get-in % [:fit-ctx :metamorph/data])))\\n       (sort-by :metric)\\n       reverse))\", :bg-class \"bg-light\"}]] nil nil], \"297\" [:div [:p] nil nil [:p/markdown \"## Introduction \"]], \"278\" [:div [:p] nil nil [:p/markdown \"Evaluate all 10 pipelines and keep results\"]], \"311\" [:div [:p] nil nil [:p/markdown \"The default k-fold splits makes 10 folds,\\nso we train 10 models, each having its own loss.\"]], \"199\" [:div [:p] nil nil [:p/markdown \"We can get for example,  the models like this:\"]], \"186\" [:div [:p] nil nil [:p/markdown \"### Use Pclass, Sex, title, age for prediction\"]], \"261\" [:div [:p] nil nil [:p/markdown \"They controll as well which information is returned.\"]], \"284\" [:div [:p] nil nil [:p/markdown \"As we sorted by mean accuracy, the first evaluation result is the best model,\"]], \"267\" [:div [:p] [:div [:p/code {:code \"(def predictions\\n  (->\\n   (pipeline-fn\\n    (assoc\\n     (:fit-ctx (first models))\\n     :metamorph/data (:test ds-split)\\n     :metamorph/mode :transform))\\n   :metamorph/data))\", :bg-class \"bg-light\"}]] nil nil], \"307\" [:div [:p] nil nil [:p/markdown \"The pipeline definition\"]], \"312\" [:div [:p] nil nil [:p/markdown \"The `evaluate-pipelines` fn averages the models per pipe-fn,\\nand returns the best.\\nSo we get a single model back, as we only have one pipe fn\"]], \"276\" [:div [:p] nil nil [:p/markdown \"Generate the 10 pipeline-fn we want to evaluate.\"]], \"331\" [:div [:p] nil nil [:p/markdown \"with a accuracy of \\n0.8472222222222222\"]], \"308\" [:div [:p] [:div [:p/code {:code \"(def pipeline-fn\\n  (ml/pipeline\\n   (mm/select-columns [:survived :pclass :name :sex :age])\\n\\n   ;; included th custom function via lifting in the pipeline\\n   (ml/lift name->title)\\n\\n   (mm/categorical->number [:survived :pclass :sex :title])\\n   (mm/set-inference-target :survived)\\n\\n   ;; we overwrite the id, so the model function will store\\n   ;; it's output (the model) in the pipeline ctx under key :model\\n   {:metamorph/id :model}\\n   (mm/model {:model-type :smile.classification/random-forest})))\", :bg-class \"bg-light\"}]] nil nil], \"313\" [:div [:p] [:div [:p/code {:code \"(def models\\n  (->> evaluations\\n       flatten\\n       (map\\n        #(hash-map :model (ml/thaw-model (get-in % [:fit-ctx :model]))\\n                   :metric (:metric %)\\n                   :fit-ctx (:fit-ctx %)\\n                   ))\\n       (sort-by :mean)\\n       reverse))\", :bg-class \"bg-light\"}]] nil nil], \"320\" [:div [:p] nil nil [:p/markdown \"Out of the predictions and the truth, we can construct the\\n confusion matrix.\"]], \"325\" [:div [:p] [:div [:p/code {:code \"(def evaluations\\n  (ml/evaluate-pipelines\\n   pipeline-fns\\n   train-val-splits\\n   ml/classification-accuracy\\n   :accuracy\\n   {:keep-best-pipeline-only false\\n    :keep-best-cross-validation-only false\\n    :map-fn :pmap\\n    :result-dissoc-seq []\\n    }\\n   ))\", :bg-class \"bg-light\"}]] nil nil], \"306\" [:div [:p] [:div [:p/code {:code \"(defn name->title [dataset]\\n  (-> dataset\\n      (ds/add-or-replace-column\\n       :title\\n       (map\\n        #(-> % (str/split  #\\\"\\\\.\\\")\\n             first\\n             (str/split  #\\\"\\\\,\\\")\\n             last\\n             str/trim)\\n        (data :name)))\\n      (ds/drop-columns :name)))\", :bg-class \"bg-light\"}]] nil nil], \"316\" [:div [:p] nil nil [:p/markdown \"The one with the highest accuracy is then:\"]], \"324\" [:div [:p] [:div [:p/code {:code \"(def pipeline-fns (map make-pipeline-fn search-grid))\", :bg-class \"bg-light\"}]] nil nil], \"260\" [:div [:p] nil nil [:p/markdown \"Often we consider the model with the lowest loss to be the best.\"]], \"301\" [:div [:p] nil nil [:p/markdown \"Column names:\"]], \"317\" [:div [:p] [:div [:p/code {:code \"(-> models first :model )\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"#object[smile.classification.RandomForest 0x5cee37e7 \\\"smile.classification.RandomForest@5cee37e7\\\"]\\n\"}]], \"280\" [:div [:p] nil nil [:p/markdown \"Get the key information from the evaluations and sort by the metric function used,\\n accuracy here.\"]], \"319\" [:div [:p] [:div [:p/code {:code \"^kind/dataset\\npredictions\", :bg-class \"bg-light\"}]] nil [:div {:class \"table table-striped table-hover table-condensed table-responsive\", :style {:height \"400px\"}} [:p/markdown \":_unnamed [179 3]:\\n\\n|       0 |       1 | :survived |\\n|---------|---------|-----------|\\n|  0.7394 |  0.2606 |       0.0 |\\n|  0.6355 |  0.3645 |       0.0 |\\n|  0.4748 |  0.5252 |       1.0 |\\n|  0.7134 |  0.2866 |       0.0 |\\n|  0.6369 |  0.3631 |       0.0 |\\n|  0.6777 |  0.3223 |       0.0 |\\n|  0.5052 |  0.4948 |       0.0 |\\n|  0.4619 |  0.5381 |       1.0 |\\n|  0.7536 |  0.2464 |       0.0 |\\n|  0.7605 |  0.2395 |       0.0 |\\n|  0.6544 |  0.3456 |       0.0 |\\n|  0.4208 |  0.5792 |       1.0 |\\n|  0.7541 |  0.2459 |       0.0 |\\n|  0.3927 |  0.6073 |       1.0 |\\n|  0.6425 |  0.3575 |       0.0 |\\n|  0.7115 |  0.2885 |       0.0 |\\n|  0.6677 |  0.3323 |       0.0 |\\n|  0.7673 |  0.2327 |       0.0 |\\n|  0.7605 |  0.2395 |       0.0 |\\n|  0.6736 |  0.3264 |       0.0 |\\n|  0.7002 |  0.2998 |       0.0 |\\n|  0.4325 |  0.5675 |       1.0 |\\n|  0.4542 |  0.5458 |       1.0 |\\n|  0.7231 |  0.2769 |       0.0 |\\n|  0.6544 |  0.3456 |       0.0 |\\n\"]]], \"298\" [:div [:p] nil nil [:p/markdown \" In this example, we will train a model which is able to predict the survival of passengers from the Titanic dataset.\\nIn a real analysis, this would contain as well explorative analysis of the data, which I will skip here,\\nas the purpose is to showcase machine learning with scicloj.ml, which is about model evaluation and selection.\"]], \"322\" [:div [:p] [:div [:p/code {:code \"^kind/dataset\\n(->\\n (ml/confusion-map (:survived predictions)\\n                        (:survived trueth)\\n                        :none)\\n (ml/confusion-map->ds))\", :bg-class \"bg-light\"}]] nil [:div {:class \"table table-striped table-hover table-condensed table-responsive\", :style {:height \"230px\"}} [:p/markdown \"_unnamed [3 3]:\\n\\n| :column-name |       0 |       1 |\\n|--------------|---------|---------|\\n|  column-name |       0 |       1 |\\n|            0 |     105 |       7 |\\n|            1 |      35 |      32 |\\n\"]]], \"198\" [:div [:p] nil nil [:p/markdown \"`tech.ml` stores the models in the context in a serialzed form,\\nand the function `thaw-model` can be used to get the original model back.\\nThis is a Java class in the case of\\n model :smile.classification/random.forest, but this depends on the\\nwhich `model` function is in the pipeline\"]], \"233\" [:div [:p] nil nil [:p/markdown \"Use sobol optimization, to find 10 grid points,\\nwhich cover in a smart way the hyper-parameter space.\"]], \"182\" [:div [:p] nil nil [:p/markdown \"The following splits the dataset in three pieces,\\n train, val and test to predict on later.\\n\"]], \"310\" [:div [:p] [:div [:p/code {:code \"(def evaluations\\n  (ml/evaluate-pipelines\\n   [pipeline-fn]\\n   train-val-splits\\n   ml/classification-accuracy\\n   :accuracy))\", :bg-class \"bg-light\"}]] nil nil], \"327\" [:div [:p] [:div [:p/code {:code \"(count models)\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"100\\n\"}]], \"204\" [:div [:p] nil nil [:p/markdown \"We can get the predictions on new-data, which for classification contain as well\\nthe posterior probabilities per class.\"]], \"333\" [:div [:p] [:div [:p/code {:code \"(-> best-model :fit-ctx :model :options)\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"{:trees 366.66666666666663,\\n :split-rule :entropy,\\n :max-depth 22.777777777777775,\\n :node-size 9.0,\\n :sample-rate 0.2,\\n :use-age? false,\\n :model-type :smile.classification/random-forest}\\n\"}]], \"330\" [:div [:p] [:div [:p/code {:code \"(:model best-model)\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"#object[smile.classification.RandomForest 0x6886bcd6 \\\"smile.classification.RandomForest@6886bcd6\\\"]\\n\"}]], \"187\" [:div [:p] nil nil [:p/markdown \"We want to create a new column :title which might help in the score.\\nThis is an example of custom function, which creates a new column from existing columns,\\nwhich is a typical case of feature engineering.\"]], \"323\" [:div [:p] nil nil [:p/markdown \"### Hyper parameter tuning\"]], \"309\" [:div [:p] nil nil [:p/markdown \"Evaluate the (single) pipeline function using the train/test split\"]], \"117\" [:div [:p] [:div [:p/code {:code \"(-> best-model :fit-ctx :model :options)\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"{:trees 455.55555555555554,\\n :split-rule :gini,\\n :max-depth 33.666666666666664,\\n :node-size 3.0,\\n :sample-rate 0.4,\\n :use-age? false,\\n :model-type :smile.classification/random-forest}\\n\"}]], \"314\" [:div [:p] nil nil [:p/markdown \"The accuracy of the best trained model is:\"]]}}");
     document.getElementById("loading").remove();
    </script>
</html>
