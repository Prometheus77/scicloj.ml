<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.0/sandstone/bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/solarized-light.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/24.0.0/styles/ag-grid.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/24.0.0/styles/ag-theme-balham.min.css" rel="stylesheet" type="text/css">
        <link href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" rel="stylesheet" type="text/css">

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
        <!-- The loading of KaTeX is deferred to speed up page rendering -->
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
    </head>
    <body>
        <p id="loading">Loading ...</p>
        <div id="app"></div>
    </body>
    <script src="https://cdn.statically.io/gh/scicloj/gorilla-notes@master/dist/0.5.10/main.js"></script>
    <script>
     shadow.loader.load("main");
     gorilla_notes.main.main_BANG_(false, "{:options {:reverse-notes? false, :header? false, :notes-in-cards? false, :initially-collapse? false, :auto-scroll? false, :port 1903, :custom-header [:div {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} \"(notespace)\" [:p \"Thu Apr 08 18:52:41 CEST 2021\"] nil [:hr]], :custom-footer [:div [:hr] [:hr]]}, :ids [\"196\" \"197\" \"198\" \"199\" \"200\" \"201\" \"202\" \"203\" \"204\" \"205\" \"206\" \"207\" \"208\" \"209\" \"210\" \"211\" \"212\" \"213\" \"214\" \"215\" \"216\" \"217\" \"218\" \"219\" \"220\" \"221\" \"222\" \"223\" \"224\" \"225\"], :id->content {\"219\" [:div [:p] nil nil [:p/markdown \"### Lifting a existing dataset->dataset transformation fn\"]], \"201\" [:div [:p] nil nil [:p/markdown \"### Custom metamorph compliant function\"]], \"202\" [:div [:p] nil nil [:p/markdown \"### Custom model function\"]], \"224\" [:div [:p] nil nil [:p/markdown \"Not working yet\"]], \"196\" [:div [:p] [:div [:p/code {:code \"(comment\\n  (note/init-with-browser)\\n  (notespace.api/update-config\\n   #(assoc % :source-base-path \\\"userguide\\\"))\\n\\n  (note/eval-this-notespace)\\n  (note/reread-this-notespace)\\n  (note/render-static-html \\\"docs/userguide-advanced.html\\\")\\n  (note/init) )\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"nil\\n\"}]], \"207\" [:div [:p] [:div [:p/code {:code \"(def test-data\\n  (ds/dataset {:time [11 12 13 14 15]\\n               :val [nil nil  nil nil nil ]}))\", :bg-class \"bg-light\"}]] nil nil], \"221\" [:div [:p] nil nil [:p/markdown \"### Special keys in metamorph context map\"]], \"213\" [:div [:p] [:div [:p/code {:code \"(def trained-ctx\\n  (pipe-fn {:metamorph/data train-data\\n         :metamorph/mode :fit}))\", :bg-class \"bg-light\"}]] nil nil], \"197\" [:div [:p] nil nil [:p/markdown \"### Debugging a metamorph pipeline\"]], \"225\" [:div [:p] [:div [:p/code {:code \"(comment\\n  (def reviews\\n    (ds/dataset \\\"https://github.com/scicloj/metamorph-examples/raw/main/data/reviews.csv.gz\\\"\\n                {:key-fn keyword}))\\n  (def reviews-split\\n    (first\\n     (ds/split->seq reviews :holdout)))\\n\\n  (def pipe-fn\\n    (ml/pipeline\\n     (mm/select-columns [:Text :Score ])\\n     (mm/count-vectorize :Text :bow)\\n     (mm/bow->sparse-array :bow :bow-sparse)\\n     (mm/set-inference-target :Score)\\n     (mm/select-columns [:bow-sparse :Score])\\n     ;; It takes key :scicloj.ml.smile.metamorph/bow->sparse-vocabulary\\n     ;; from ctx and sets it in the next step\\n     (fn [ctx]\\n       (let [p (-> ctx :scicloj.ml.smile.metamorph/bow->sparse-vocabulary\\n                   :vocab\\n                   count\\n                   )]\\n         ((mm/model {:p p\\n                     :model-type :smile.classification/maxent-multinomial\\n                     :sparse-column :bow-sparse})\\n          ctx)\\n         )\\n       ctx\\n       )\\n     ))\\n\\n  (def trained-ctx\\n    (pipe-fn {:metamorph/data (:train reviews-split)\\n              :metamorph/mode :fit}))\\n\\n  )\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"nil\\n\"}]], \"203\" [:div [:p] nil nil [:p/markdown \"In this chapter we see how to build a custom metamorph compliant function, which behaves like a simple model.\\nIt takes the mean of the training data and applies this the to the test data.\\n\"]], \"212\" [:div [:p] nil nil [:p/markdown \"We run the training as usual, passing a map of data and mode. (The id gets added automatically)\"]], \"199\" [:div [:p] nil nil [:p/markdown \"### Custom dataset->dataset transforming functions in a metamorph pipeline\"]], \"210\" [:div [:p] nil nil [:p/markdown \"The pipeline has only one step, the model function itself.\"]], \"222\" [:div [:p] nil nil [:p/markdown \"### Set custom id\"]], \"208\" [:div [:p] nil nil [:p/markdown \"Next we create the model function. It makes use of namespaced\\nkey destructuring, which allows very compact code.\\n\\nThe :id,:data and :mode keys from the context ctx,\\nbecome local bindings.\\n\\nIn :mode :fit, we calculate the mean of the (training) data and store it in ctx under an `id` which is passed to\\nthe function by `metamorph` and is a unique id of the step.\\nThis we use then as key to store the mean in the context, so that in :transform we can read it from the ctx under the same `id`.\\nThe `id` passed into the function is the same in :fit and :transform (but unique per step)\\nSo we see how to pass data from the pipeline run in mode :fit to the run in mode :transform.\\n\"]], \"218\" [:div [:p] [:div [:p/code {:code \"prediction\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"_unnamed [5 2]:\\n\\n|  :time |     :val |\\n|--------|----------|\\n|     11 |     11.9 |\\n|     12 |     11.9 |\\n|     13 |     11.9 |\\n|     14 |     11.9 |\\n|     15 |     11.9 |\\n\\n\"}]], \"209\" [:div [:p] [:div [:p/code {:code \"(defn mean-model []\\n  (fn [{:metamorph/keys [id data mode] :as ctx}]\\n    (case mode\\n      :fit\\n      (let [vals-so-far (-> data :val seq)\\n            mean-so-far (fun/mean vals-so-far)\\n            ]\\n        (assoc ctx id mean-so-far)\\n        )\\n      :transform\\n      (let [mean-so-far (get ctx id)\\n            updated-ds (-> data\\n                           (ds/add-or-replace-column :val mean-so-far ))]\\n        (assoc ctx :metamorph/data updated-ds)))))\", :bg-class \"bg-light\"}]] nil nil], \"200\" [:div [:p] nil nil [:p/markdown \"### inline fn\"]], \"223\" [:div [:p] nil nil [:p/markdown \"## More advanced use case, as we need to pass the vocab size between\\n steps\"]], \"205\" [:div [:p] nil nil [:p/markdown \"Here we create dummy training data, which is like a time series.\\nWe have values for time step 1-10, and want to predict (using the mean),\\nthe value for future timestpes.\\n\"]], \"206\" [:div [:p] [:div [:p/code {:code \"(def train-data\\n  (ds/dataset {:time [1 2 3 4 5 6 7 8 9 10]\\n               :val [1 3 4 4 20 3 4 18 39 23]}))\", :bg-class \"bg-light\"}]] nil nil], \"216\" [:div [:p] nil nil [:p/markdown \"This runs the pipeline again and we have the prediction available in :metamorph/data\"]], \"217\" [:div [:p] [:div [:p/code {:code \"(def prediction\\n  (:metamorph/data predicted-ctx))\", :bg-class \"bg-light\"}]] nil nil], \"211\" [:div [:p] [:div [:p/code {:code \"(def pipe-fn\\n  (ml/pipeline\\n   (mean-model)\\n   ))\", :bg-class \"bg-light\"}]] nil nil], \"198\" [:div [:p] nil nil [:p/markdown \"### Model selection\"]], \"220\" [:div [:p] nil nil [:p/markdown \"### Keep auxiliary data in pipeline\"]], \"204\" [:div [:p] [:div [:p/code {:code \"(require  '[scicloj.ml.core :as ml]\\n          '[scicloj.ml.metamorph :as mm]\\n          '[scicloj.ml.dataset :as ds]\\n          '[tech.v3.datatype.functional :as fun]\\n          )\", :bg-class \"bg-light\"}]] nil nil], \"214\" [:div [:p] nil nil [:p/markdown \"Same for the prediction, in mode :transform, merging in the trained-ctx but overwriting data and mode\"]], \"215\" [:div [:p] [:div [:p/code {:code \"(def predicted-ctx\\n  (pipe-fn\\n   (merge trained-ctx\\n          {:metamorph/data test-data\\n           :metamorph/mode :transform})))\", :bg-class \"bg-light\"}]] nil nil]}}");
     document.getElementById("loading").remove();
    </script>
</html>
