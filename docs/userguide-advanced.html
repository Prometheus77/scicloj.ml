<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.0/sandstone/bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/solarized-light.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/24.0.0/styles/ag-grid.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/24.0.0/styles/ag-theme-balham.min.css" rel="stylesheet" type="text/css">
        <link href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" rel="stylesheet" type="text/css">

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
        <!-- The loading of KaTeX is deferred to speed up page rendering -->
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
    </head>
    <body>
        <p id="loading">Loading ...</p>
        <div id="app"></div>
    </body>
    <script src="https://cdn.statically.io/gh/scicloj/gorilla-notes@master/dist/0.5.10/main.js"></script>
    <script>
     shadow.loader.load("main");
     gorilla_notes.main.main_BANG_(false, "{:options {:reverse-notes? false, :header? false, :notes-in-cards? false, :initially-collapse? false, :auto-scroll? false, :port 1903, :custom-header [:div {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} \"(notespace)\" [:p \"Thu Apr 08 21:36:58 CEST 2021\"] nil [:hr]], :custom-footer [:div [:hr] [:hr]]}, :ids [\"1337\" \"1338\" \"1339\" \"1203\" \"1340\" \"1341\" \"1342\" \"1343\" \"1275\" \"1276\" \"1344\" \"1345\" \"1279\" \"1280\" \"1281\" \"1346\" \"1283\" \"1347\" \"1285\" \"1348\" \"1349\" \"1350\" \"1351\" \"1290\" \"1291\" \"1292\" \"1293\" \"1352\" \"1295\" \"1296\" \"1297\" \"1298\" \"1353\" \"1300\" \"1354\" \"1355\" \"1303\" \"1304\" \"1356\" \"1357\" \"1358\" \"1308\" \"1309\" \"1359\" \"1311\" \"1312\" \"1313\" \"1360\" \"1361\" \"1362\" \"1363\" \"1364\" \"1365\" \"1366\" \"1321\" \"1322\" \"1367\" \"1324\" \"1325\" \"1368\" \"1327\" \"1369\" \"1329\" \"1330\" \"1331\" \"1370\" \"1333\" \"1371\" \"1335\" \"1372\"], :id->content {\"1345\" [:div [:p] nil nil [:p/markdown \"The first is to comment out parts of the pipeline, run it and\\n inspect the result, the context\"]], \"1360\" [:div [:p] [:div [:p/code {:code \"(pipe-fn-lift {:metamorph/data (ds/dataset {:val [-2 100 2000]})})\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"#:metamorph{:data _unnamed [3 1]:\\n\\n|      :val |\\n|-----------|\\n| :negative |\\n|      :low |\\n|     :high |\\n}\\n\"}]], \"1365\" [:div [:p] nil nil [:p/markdown \"Here we create dummy training data, which is like a time series.\\nWe have values for time step 1-10, and want to predict (using the mean),\\nthe value for future timesteps.\\n\"]], \"1358\" [:div [:p] nil nil [:p/markdown \"And then we include it into the pipeline via\\nlifting the ds->ds function into\\na :metamorph/data -> :metamorph/data function\"]], \"1368\" [:div [:p] nil nil [:p/markdown \"We run the training as usual, passing a map of data and mode. (The id gets added automatically)\"]], \"1321\" [:div [:p] [:div [:p/code {:code \"(def test-data\\n  (ds/dataset {:time [11 12 13 14 15]\\n               :val [nil nil  nil nil nil ]}))\", :bg-class \"bg-light\"}]] nil nil], \"1308\" [:div [:p] [:div [:p/code {:code \"(def pipe-fn-lift\\n  (ml/pipeline\\n   (ml/lift ds->cat)))\", :bg-class \"bg-light\"}]] nil nil], \"1346\" [:div [:p] [:div [:p/code {:code \"trained-ctx\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"#:metamorph{:data _unnamed [3 1]:\\n\\n|  :time |\\n|--------|\\n|      1 |\\n|      2 |\\n|      3 |\\n, :mode :fit}\\n\"}]], \"1363\" [:div [:p] nil nil [:p/markdown \"In this chapter we see how to build a custom metamorph compliant function, which behaves like a simple model.\\nIt takes the mean of the training data and applies this the to the test data.\\n\"]], \"1275\" [:div [:p] nil nil [:p/markdown \"These are then used by function `scicloj.ml.core/evaluate-pipelines` to do performace measurements of a model\"]], \"1364\" [:div [:p] [:div [:p/code {:code \"(require  '[scicloj.ml.core :as ml]\\n          '[scicloj.ml.metamorph :as mm]\\n          '[scicloj.ml.dataset :as ds]\\n          '[tech.v3.datatype.functional :as fun]\\n          )\", :bg-class \"bg-light\"}]] nil nil], \"1303\" [:div [:p] [:div [:p/code {:code \"(def pipe-fn-inline\\n  (ml/pipeline\\n   (fn [{:metamorph/keys [data]}]\\n     (ds/add-or-replace-column data :val (fn [ds] (map ->cat (:val ds)))))))\", :bg-class \"bg-light\"}]] nil nil], \"1296\" [:div [:p] nil nil [:p/markdown \"Lets take as an example, a function which encodes a column with a numerical value to 3 categorical values:\\n\\n - < 0         -> :negative\\n - > 0 - 1000  -> :low\\n - > 1000      -> :high\\n\\n \"]], \"1203\" [:div [:p] nil nil [:p/markdown \" `:metamorph/data` contains the main data object, the pipeline\\n is supposed to manipulate. The type of object can be anything, but all\\nfunctionality on `scicloj.ml` requires it to be a `tech.v3.dataset`\\n instance. For further information see in\\n [metamorph](https://github.com/scicloj/metamorph)\"]], \"1342\" [:div [:p] nil nil [:p/markdown \"Two functions in `scicloj.ml` use two further keys with the purpose of model evaluation, see further down in this guide.\"]], \"1349\" [:div [:p] [:div [:p/code {:code \"ctx-2\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"#:metamorph{:data _unnamed [3 1]:\\n\\n|  :time |\\n|--------|\\n|      1 |\\n|      2 |\\n|      3 |\\n, :mode :fit, :id #uuid \\\"ae156399-7074-4bcd-8027-b07231cd9dc7\\\"}\\n\"}]], \"1338\" [:div [:p] nil nil [:p/markdown \"### Special keys in metamorph context map\"]], \"1283\" [:div [:p] nil nil [:p/markdown \"The second alternative is to capture the state of the ctx in arbitrary\\n steps\"]], \"1309\" [:div [:p] nil nil [:p/markdown \"### Metamorph compliant function\"]], \"1344\" [:div [:p] nil nil [:p/markdown \"A metamorph pipeline can be debugged by two simple techniques.\"]], \"1347\" [:div [:p] [:div [:p/code {:code \"(def pipe-fn\\n  (ml/pipeline\\n   (fn [ctx] (def ctx-1 ctx) ctx)\\n   (mm/select-columns [:time])\\n   (fn [ctx] (def ctx-2 ctx) ctx)\\n   ;; (mm/step-2)\\n   ;; (mm/step-3)\\n   ;; (mm/step-4)\\n   ))\", :bg-class \"bg-light\"}]] nil nil], \"1325\" [:div [:p] [:div [:p/code {:code \"(def pipe-fn\\n  (ml/pipeline\\n   (mean-model)\\n   ))\", :bg-class \"bg-light\"}]] nil nil], \"1276\" [:div [:p] nil nil [:p/markdown \"## Debugging a metamorph pipeline\"]], \"1322\" [:div [:p] nil nil [:p/markdown \"Next we create the model function. It makes use of namespaced\\nkey destructuring, which allows very compact code.\\n\\nThe :id,:data and :mode keys from the context ctx,\\nbecome local bindings.\\n\\nIn :mode :fit, we calculate the mean of the (training) data and store it in ctx under an `id` which is passed to\\nthe function by `metamorph` and is a unique id of the step.\\nThis we use then as key to store the mean in the context, so that in :transform we can read it from the ctx under the same `id`.\\nThe `id` passed into the function is the same in :fit and :transform (but unique per step)\\nSo we see how to pass data from the pipeline run in mode :fit to the run in mode :transform.\\n\"]], \"1372\" [:div [:p] nil nil nil], \"1341\" [:div [:p] nil nil [:p/markdown \"`:metamorph/id` contains at every step a different , unique, id. A model function can use it\\nto store the trained model in :fit and use it it :transform for prediction\"]], \"1354\" [:div [:p] nil nil [:p/markdown \"### Inline fn\"]], \"1292\" [:div [:p] nil nil [:p/markdown \"1. Data manipulation functions. Use only :metamorph/data\\n  2. Model type of functions. They use :metamorph/data , :metamorph/mode, :metamorph:id\\n     and behave different in mode :fit  and :mode transform. Eventually they use other keys in the context.\\n  3. They use other keys in the context to pass auxiliary data\\n\"]], \"1300\" [:div [:p] nil nil [:p/markdown \"1. Inline\\n  2. Lifting\\n  3. Named function\\n\"]], \"1281\" [:div [:p] [:div [:p/code {:code \"(def trained-ctx\\n  (pipe-fn {:metamorph/data train-data\\n            :metamorph/mode :fit}))\", :bg-class \"bg-light\"}]] nil nil], \"1355\" [:div [:p] nil nil [:p/markdown \"We can define inline a metamorph compliant function\"]], \"1339\" [:div [:p] nil nil [:p/markdown \"A metamorph context map can contain arbitrary keys. Three keys are\\n special and they enable the functioning of the pipeline . All steps should\\nhandle them in the same way.\"]], \"1361\" [:div [:p] [:div [:p/code {:code \"(pipe-fn-mm {:metamorph/data (ds/dataset {:val [-2 100 2000]})})\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"_unnamed [3 1]:\\n\\n|      :val |\\n|-----------|\\n| :negative |\\n|      :low |\\n|     :high |\\n\\n\"}]], \"1333\" [:div [:p] nil nil [:p/markdown \"### Keep auxiliary data in pipeline\"]], \"1337\" [:div [:p] [:div [:p/code {:code \"(comment\\n  (note/init-with-browser)\\n  (notespace.api/update-config\\n   #(assoc % :source-base-path \\\"userguide\\\"))\\n\\n  (note/eval-this-notespace)\\n  (note/reread-this-notespace)\\n  (note/render-static-html \\\"docs/userguide-advanced.html\\\")\\n  (note/init) )\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"nil\\n\"}]], \"1370\" [:div [:p] [:div [:p/code {:code \"prediction\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"_unnamed [5 2]:\\n\\n|  :time |     :val |\\n|--------|----------|\\n|     11 |     11.9 |\\n|     12 |     11.9 |\\n|     13 |     11.9 |\\n|     14 |     11.9 |\\n|     15 |     11.9 |\\n\\n\"}]], \"1357\" [:div [:p] [:div [:p/code {:code \"(defn ds->cat [ds]\\n  (ds/add-or-replace-column ds :val (fn [ds] (map ->cat (:val ds)))))\", :bg-class \"bg-light\"}]] nil nil], \"1291\" [:div [:p] nil nil [:p/markdown \"Conceptually we have three types of functions, they differ by which keys in\\n the context they manipulate.\"]], \"1340\" [:div [:p] nil nil [:p/markdown \"`:metamorph/mode` is used by 'model' functions, which get fitted from data or transform data.\\nTwo modes are standardized, namelye: `:fit` and `:transform`. In machine learninig they often are called train / predict.\\n`sciform.ml` requires them to be `:fit` and `:transform`, and\\nthird party libraries should adhere to this convention.\\n\"]], \"1290\" [:div [:p] nil nil [:p/markdown \"Custom steps in metamorph pipelines are normal Clojure functions.\"]], \"1311\" [:div [:p] [:div [:p/code {:code \"(defn mm->cat []\\n  (fn [{:metamorph/keys [data]}]\\n    (ds/add-or-replace-column data :val (fn [ds] (map ->cat (:val ds))))))\", :bg-class \"bg-light\"}]] nil nil], \"1329\" [:div [:p] [:div [:p/code {:code \"(def predicted-ctx\\n  (pipe-fn\\n   (merge trained-ctx\\n          {:metamorph/data test-data\\n           :metamorph/mode :transform})))\", :bg-class \"bg-light\"}]] nil nil], \"1343\" [:div [:p] nil nil [:p/markdown \"`scicloj.ml.core/model` stores the feature-dataset and the inference-target-dataset in the ctx before doing a prediction\\nat keys `:scicloj.metamorph.ml/feature-ds` and  `:scicloj.metamorph.ml/target-ds`\"]], \"1362\" [:div [:p] nil nil [:p/markdown \"### Custom model function\"]], \"1352\" [:div [:p] nil nil [:p/markdown \"Most steps of a pipeline are about modifying the dataset, so most custom code will be here.\\nIn machine learning, this is as well known as feature engineering, as new features get created from existing features.\"]], \"1353\" [:div [:p] nil nil [:p/markdown \"We have now three different ways to write a metamorph compliant function\"]], \"1295\" [:div [:p] nil nil [:p/markdown \"For a custom data manipulation function to be able to participate in a metamorph pipeline it needs to:\\n\\n1. Take a context map as input\\n2. Return a context map\\n3. Modify the dataset at key :metamorph/data\\n4. Not use any other key in ctx\\n5. Not change any other key ctx\\n\\n\"]], \"1312\" [:div [:p] [:div [:p/code {:code \"(def pipe-fn-mm\\n  (ml/pipeline\\n   (mm->cat)))\", :bg-class \"bg-light\"}]] nil nil], \"1298\" [:div [:p] [:div [:p/code {:code \"(defn ->cat [x]\\n  (cond (< x 0 )          :negative\\n        (and (pos? x)\\n             (< x 1000) ) :low\\n        true              :high))\", :bg-class \"bg-light\"}]] nil nil], \"1313\" [:div [:p] [:div [:p/code {:code \"(pipe-fn-inline {:metamorph/data (ds/dataset {:val [-2 100 2000]})})\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"_unnamed [3 1]:\\n\\n|      :val |\\n|-----------|\\n| :negative |\\n|      :low |\\n|     :high |\\n\\n\"}]], \"1369\" [:div [:p] nil nil [:p/markdown \"Same for the prediction, in mode :transform, merging in the trained-ctx but overwriting data and mode\"]], \"1280\" [:div [:p] [:div [:p/code {:code \"(def pipe-fn\\n  (ml/pipeline\\n   (mm/select-columns [:time])\\n   ;; (mm/step-2)\\n   ;; (mm/step-3)\\n   ;; (mm/step-4)\\n   ))\", :bg-class \"bg-light\"}]] nil nil], \"1350\" [:div [:p] nil nil [:p/markdown \"The context contains as well the dataset, which could be large.\\n So other tools for inspecting Clojure maps, are usefull.\"]], \"1366\" [:div [:p] [:div [:p/code {:code \"(def train-data\\n  (ds/dataset {:time [1 2 3 4 5 6 7 8 9 10]\\n               :val [1 3 4 4 20 3 4 18 39 23]}))\", :bg-class \"bg-light\"}]] nil nil], \"1279\" [:div [:p] [:div [:p/code {:code \"(def train-data\\n  (ds/dataset {:time [1 2 3]\\n               :val [1 3 4]}))\", :bg-class \"bg-light\"}]] nil nil], \"1367\" [:div [:p] [:div [:p/code {:code \"(defn mean-model []\\n  (fn [{:metamorph/keys [id data mode] :as ctx}]\\n    (case mode\\n      :fit\\n      (let [vals-so-far (-> data :val seq)\\n            mean-so-far (fun/mean vals-so-far)\\n            ]\\n        (assoc ctx id mean-so-far)\\n        )\\n      :transform\\n      (let [mean-so-far (get ctx id)\\n            updated-ds (-> data\\n                           (ds/add-or-replace-column :val mean-so-far ))]\\n        (assoc ctx :metamorph/data updated-ds)))))\", :bg-class \"bg-light\"}]] nil nil], \"1348\" [:div [:p] [:div [:p/code {:code \"ctx-1\", :bg-class \"bg-light\"}]] nil [:p/code {:code \"#:metamorph{:data _unnamed [3 2]:\\n\\n|  :time |   :val |\\n|--------|--------|\\n|      1 |      1 |\\n|      2 |      3 |\\n|      3 |      4 |\\n, :mode :fit, :id #uuid \\\"63f31e29-1657-43c1-baf5-96b887596988\\\"}\\n\"}]], \"1304\" [:div [:p] nil nil [:p/markdown \"### Lift a dataset->dataset function\"]], \"1297\" [:div [:p] nil nil [:p/markdown \"Helper function which doe the transformation of a single value\"]], \"1327\" [:div [:p] [:div [:p/code {:code \"(def trained-ctx\\n  (pipe-fn {:metamorph/data train-data\\n         :metamorph/mode :fit}))\", :bg-class \"bg-light\"}]] nil nil], \"1324\" [:div [:p] nil nil [:p/markdown \"The pipeline has only one step, the model function itself.\"]], \"1371\" [:div [:p] nil nil [:p/markdown \"### Set custom id\"]], \"1285\" [:div [:p] [:div [:p/code {:code \"(def ctx\\n  (pipe-fn {:metamorph/data train-data\\n            :metamorph/mode :fit}))\", :bg-class \"bg-light\"}]] nil nil], \"1331\" [:div [:p] [:div [:p/code {:code \"(def prediction\\n  (:metamorph/data predicted-ctx))\", :bg-class \"bg-light\"}]] nil nil], \"1330\" [:div [:p] nil nil [:p/markdown \"This runs the pipeline again and we have the prediction available in :metamorph/data\"]], \"1335\" [:div [:p] nil nil [:p/markdown \"## More advanced use case, as we need to pass the vocab size between steps\"]], \"1356\" [:div [:p] nil nil [:p/markdown \"First we create a functions which manipulates the dataset as we want\"]], \"1359\" [:div [:p] nil nil [:p/markdown \"We write directly a metamorph compliant, named , function.\\nThe body of the function is the same as the body of the inline fn from before.\\n\"]], \"1351\" [:div [:p] nil nil [:p/markdown \"### Custom metamorph compliant function\"]], \"1293\" [:div [:p] nil nil [:p/markdown \"## Custom dataset->dataset transforming functions \"]]}}");
     document.getElementById("loading").remove();
    </script>
</html>
